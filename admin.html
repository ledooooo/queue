<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>body{font-family:'Tajawal',sans-serif;background:#d0e6f2}</style>
</head>
<body class="min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-[#004156] mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª</h1>

  <!-- Ø¬Ø²Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ -->
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4">
    <h2 class="text-xl font-bold text-[#004156]">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>

    <!-- Ø­Ù‚Ù„ Ù†Øµ -->
    <input id="clientName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" class="w-full p-3 border rounded-lg text-lg">

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… -->
    <div class="flex gap-3">
      <button id="sendBtn" class="flex-1 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¹Ø±Ø¶</button>
      <button id="micBtn"  class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">ğŸ¤ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ</button>
    </div>

    <!-- Ø±Ø³Ø§Ù„Ø© Ø­Ø§Ù„Ø© -->
    <p id="statusMsg" class="text-sm text-gray-600 text-center"></p>
  </div>

  <!-- Ø¨Ø§Ù‚ÙŠ Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (Ø¥Ø¶Ø§ÙØ©/Ø­Ø°Ù/ØªØ³Ù…ÙŠØ© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª) -->
  <div class="max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
      <h2 class="text-xl font-bold text-[#004156]">Ø¥Ø¶Ø§ÙØ© Ø¹ÙŠØ§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <input id="newInp" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" class="w-full p-3 border rounded-lg">
      <button id="addBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Ø£Ø¶Ù</button>
    </div>

    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
      <h2 class="text-xl font-bold text-[#004156]">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
      <ul id="list" class="space-y-3"></ul>
    </div>
  </div>

  <!-- Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±Ø¹Ø© -->
  <div id="adminSpeed" class="max-w-3xl mx-auto mt-6"></div>

  <script type="module">
    import { db, ref, get, set, update, remove, onValue, push } from "./js/firebase-config.js";
    import { buildSpeedControl } from "./js/tts.js";

    /* ---------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª (ÙƒÙ…Ø§ ÙƒØ§Ù†) ---------- */
    const api = {
      getClinics: async () => {
        const s = await get(ref(db, "clinics"));
        const d = s.val() || {};
        return Object.keys(d).map(id => ({ id, ...d[id] }));
      },
      addClinic: async name => {
        const r = push(ref(db, "clinics"));
        const c = { id: r.key, name, currentNumber: 0 };
        await set(r, c);
        return c;
      },
      renameClinic: (id, n) => update(ref(db, `clinics/${id}`), { name: n }),
      deleteClinic: id => remove(ref(db, `clinics/${id}`)),
    };

    async function render() {
      const list = document.getElementById('list');
      list.innerHTML = '';
      const clinics = await api.getClinics();
      if (!clinics.length) { list.innerHTML = '<li class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹ÙŠØ§Ø¯Ø§Øª</li>'; return; }
      clinics.forEach(({id, name}) => list.insertAdjacentHTML('beforeend', `
        <li class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <span class="font-bold text-lg text-[#2a3e48]">${name}</span>
          <div class="flex gap-2">
            <input type="text" class="renameInp px-3 py-1 border rounded" placeholder="Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯" data-id="${id}">
            <button class="renameBtn px-3 py-1 bg-gray-700 text-white rounded hover:bg-gray-800" data-id="${id}">ØªØ³Ù…ÙŠØ©</button>
            <button class="delBtn px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700" data-id="${id}">Ø­Ø°Ù</button>
          </div>
        </li>`));
    }
    render();

    document.getElementById('addBtn').addEventListener('click', async () => {
      const v = document.getElementById('newInp').value.trim();
      if (v) { await api.addClinic(v); document.getElementById('newInp').value = ''; render(); }
    });

    document.getElementById('list').addEventListener('click', async e => {
      const id = e.target.dataset.id;
      if (!id) return;
      if (e.target.classList.contains('delBtn')) { if (confirm('Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) { await api.deleteClinic(id); render(); } }
      if (e.target.classList.contains('renameBtn')) {
        const inp = e.target.parentElement.querySelector(`.renameInp[data-id="${id}"]`), v = inp.value.trim();
        if (v) { await api.renameClinic(id, v); inp.value = ''; render(); }
      }
    });

    /* ---------- Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (Ù†Øµ Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ) ---------- */
    const clientInp   = document.getElementById('clientName');
    const sendBtn     = document.getElementById('sendBtn');
    const micBtn      = document.getElementById('micBtn');
    const statusMsg   = document.getElementById('statusMsg');

    // Ø¥Ø±Ø³Ø§Ù„ Ù†Øµ
    sendBtn.addEventListener('click', () => {
      const name = clientInp.value.trim();
      if (!name) { statusMsg.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹'; return; }
      // Ù†Ø±Ø³Ù„ Ø§Ù„Ø§Ø³Ù… Ø¥Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØªØ­Øª Ù…Ø³Ø§Ø± "currentClient"
      set(ref(db, 'currentClient'), { name: name, timestamp: Date.now() });
      statusMsg.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø§Ø³Ù… ÙˆØ¹Ø±Ø¶Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©';
      clientInp.value = '';
    });

    // ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ (Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†)
    let mediaRecorder;
    let audioChunks = [];
    micBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) { statusMsg.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†'; return; }
      statusMsg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù';

      if (mediaRecorder && mediaRecorder.state === 'recording') {
        mediaRecorder.stop();
        return;
      }

      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        // Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù Ø¥Ù„Ù‰ Firebase Storage (Ø£Ùˆ Ø­ÙØ¸Ù‡ Ù…Ø­Ù„ÙŠØ§Ù‹ Ø«Ù… ØªØ´ØºÙŠÙ„Ù‡)
        // Ù‡Ù†Ø§ Ù†ÙƒØªÙÙŠ Ø¨Ø¹Ø±Ø¶ Ø§Ø³Ù… Ù…Ø¤Ù‚Øª
        const url = URL.createObjectURL(audioBlob);
        set(ref(db, 'currentClient'), { audioURL: url, timestamp: Date.now() });
        statusMsg.textContent = 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
    });

    /* ---------- Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±Ø¹Ø© ---------- */
    buildSpeedControl();
  </script>
</body>
</html>
