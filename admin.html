<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>body{font-family:'Tajawal',sans-serif;background:#d0e6f2}</style>
</head>
<body class="min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-[#004156] mb-6">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª</h1>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
  <div class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4">
    <h2 class="text-xl font-bold text-[#004156]">Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯ØªÙƒ</h2>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª -->
    <select id="clinicSelect" class="w-full p-3 border rounded-lg text-lg">
      <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯Ø© --</option>
    </select>

    <!-- ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©) -->
    <input id="passwordInp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" class="w-full p-3 border rounded-lg text-lg hidden">

    <!-- Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <button id="loginBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 hidden">Ø¯Ø®ÙˆÙ„</button>

    <!-- Ø±Ø³Ø§Ù„Ø© Ø®Ø·Ø£ -->
    <p id="errorMsg" class="text-sm text-red-600 text-center hidden"></p>
  </div>

  <!-- Ø¬Ø²Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ (ÙŠØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
  <div id="controlSection" class="max-w-3xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4 hidden">
    <h2 class="text-xl font-bold text-[#004156]">Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„</h2>
    <input id="clientName" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„" class="w-full p-3 border rounded-lg text-lg">
    <div class="flex gap-3">
      <button id="sendBtn" class="flex-1 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¹Ø±Ø¶</button>
      <button id="micBtn"  class="flex-1 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700">ğŸ¤ ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ</button>
    </div>
    <p id="statusMsg" class="text-sm text-gray-600 text-center"></p>
  </div>

  <!-- Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
  <div id="adminSections" class="max-w-3xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6 hidden">
    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
      <h2 class="text-xl font-bold text-[#004156]">Ø¥Ø¶Ø§ÙØ© Ø¹ÙŠØ§Ø¯Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
      <input id="newInp" type="text" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" class="w-full p-3 border rounded-lg">
      <button id="addBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Ø£Ø¶Ù</button>
    </div>
    <div class="bg-white p-6 rounded-2xl shadow-xl space-y-4">
      <h2 class="text-xl font-bold text-[#004156]">Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©</h2>
      <ul id="list" class="space-y-3"></ul>
    </div>
  </div>

  <!-- Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±Ø¹Ø© -->
  <div id="adminSpeed" class="max-w-3xl mx-auto mt-6 hidden"></div>

  <script type="module">
    import { db, ref, get, set, update, remove, onValue, push } from "./js/firebase-config.js";
    import { buildSpeedControl } from "./js/tts.js";

    /* ---------- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙØ­Ø© ---------- */
    const clinicSelect = document.getElementById('clinicSelect');
    const passwordInp  = document.getElementById('passwordInp');
    const loginBtn     = document.getElementById('loginBtn');
    const errorMsg     = document.getElementById('errorMsg');
    const controlSection = document.getElementById('controlSection');
    const adminSections  = document.getElementById('adminSections');

    let currentClinic = null; // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„

    /* ---------- Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª + Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ---------- */
    onValue(ref(db, 'clinics'), snap => {
      clinicSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯Ø© --</option>';
      snap.forEach(ch => {
        const {name} = ch.val();
        clinicSelect.insertAdjacentHTML('beforeend', `<option value="${ch.key}">${name}</option>`);
      });
    });

    /* ---------- Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹ÙŠØ§Ø¯Ø©: Ø£Ø¸Ù‡Ø± Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---------- */
    clinicSelect.addEventListener('change', () => {
      passwordInp.classList.remove('hidden');
      loginBtn.classList.remove('hidden');
      errorMsg.classList.add('hidden');
    });

    /* ---------- Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---------- */
    loginBtn.addEventListener('click', async () => {
      const clinicId = clinicSelect.value;
      const pass     = passwordInp.value.trim();
      if (!clinicId || !pass) { errorMsg.textContent = 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'; errorMsg.classList.remove('hidden'); return; }

      const clinicSnap = await get(ref(db, `clinics/${clinicId}`));
      if (!clinicSnap.exists()) { errorMsg.textContent = 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'; errorMsg.classList.remove('hidden'); return; }

      const clinic = clinicSnap.val();
      if (clinic.password !== pass) { errorMsg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'; errorMsg.classList.remove('hidden'); return; }

      // Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­: Ø£Ø®ÙÙ‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ£Ø¸Ù‡Ø± Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ­ÙƒÙ…
      currentClinic = { id: clinicId, ...clinic };
      document.querySelector('.max-w-3xl.mx-auto.bg-white.p-6.rounded-2xl.shadow-xl.mb-6').classList.add('hidden');
      controlSection.classList.remove('hidden');
      adminSections.classList.remove('hidden');
      buildSpeedControl();
      render(); // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©
    });

    /* ---------- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© (ØªØ­ÙƒÙ… ÙÙ‰ Ø§Ù„Ø±Ù‚Ù… ÙÙ‚Ø·) ---------- */
    const api = {
      getClinic: async () => {
        const s = await get(ref(db, `clinics/${currentClinic.id}`));
        return s.exists() ? s.val() : null;
      },
      advanceNumber: async () => {
        const c = await api.getClinic();
        if (!c) return null;
        const nn = (c.currentNumber || 0) + 1;
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        return { ...c, currentNumber: nn };
      },
      goBackNumber: async () => {
        const c = await api.getClinic();
        if (!c) return null;
        const nn = Math.max(0, (c.currentNumber || 0) - 1);
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        return { ...c, currentNumber: nn };
      },
      setNumber: async (v) => {
        const n = parseInt(v, 10);
        if (!isNaN(n) && n >= 0) await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: n });
      },
      resetNumber: async () => update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: 0 })
    };

    async function render() {
      const c = await api.getClinic();
      if (!c) return;
      document.getElementById('list').innerHTML = `
        <li class="flex items-center justify-between bg-gray-100 p-4 rounded-xl">
          <span class="font-bold text-lg text-[#2a3e48]">${c.name}</span>
          <p class="text-3xl font-extrabold text-[#004156]">${c.currentNumber}</p>
        </li>`;
    }

    /* ---------- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙ‰ Ø§Ù„Ø±Ù‚Ù… + Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ + ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ ---------- */
    const clientInp   = document.getElementById('clientName');
    const sendBtn     = document.getElementById('sendBtn');
    const micBtn      = document.getElementById('micBtn');
    const statusMsg   = document.getElementById('statusMsg');

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ…
    document.getElementById('adv').addEventListener('click', async () => { await api.advanceNumber(); render(); });
    document.getElementById('back').addEventListener('click', async () => { await api.goBackNumber(); render(); });
    document.getElementById('setBtn').addEventListener('click', async () => {
      const v = document.getElementById('setInp').value;
      if (v !== '') { await api.setNumber(v); document.getElementById('setInp').value = ''; } render();
    });
    document.getElementById('reset').addEventListener('click', async () => { await api.resetNumber(); render(); });

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    sendBtn.addEventListener('click', () => {
      const name = clientInp.value.trim();
      if (!name) { statusMsg.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹'; return; }
      set(ref(db, 'currentClient'), { name: name, clinic: currentClinic.name, timestamp: Date.now() });
      statusMsg.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¹Ø±Ø¶Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©';
      clientInp.value = '';
    });

    // ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ
    let mediaRecorder;
    let audioChunks = [];
    micBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) { statusMsg.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†'; return; }
      statusMsg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù';
      if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); return; }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(audioBlob);
        set(ref(db, 'currentClient'), { audioURL: url, clinic: currentClinic.name, timestamp: Date.now() });
        statusMsg.textContent = 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
    });

    /* ---------- Ø¹Ù†ØµØ± ØªØ­ÙƒÙ… Ø§Ù„Ø³Ø±Ø¹Ø© ---------- */
    buildSpeedControl();
  </script>
</body>
</html>
