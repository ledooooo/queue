<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #d0e6f2; }
    .card { background: #ffffff; border-radius: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .highlight { background: #fef3c7 !important; animation: blink 0.6s ease-in-out 4; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;}}
  </style>
</head>
<body class="min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-[#004156] mb-6">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</h1>

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4">
    <h2 class="text-xl font-bold text-[#004156]">Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯ØªÙƒ</h2>
    <select id="clinicSelect" class="w-full p-3 border rounded-lg text-lg">
      <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯Ø© --</option>
    </select>
    <input id="passwordInp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" class="w-full p-3 border rounded-lg text-lg hidden">
    <button id="loginBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 hidden">Ø¯Ø®ÙˆÙ„</button>
    <p id="errorMsg" class="text-sm text-red-600 text-center hidden"></p>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
  <div id="controlPanel" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <h2 id="clinicName" class="text-3xl font-bold text-center text-[#004156]"></h2>
    <p id="clinicNumber" class="text-7xl font-extrabold text-center text-[#2a3e48]"></p>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ù…Ø¹ Ø§Ù„Ø£Ø´ÙƒØ§Ù„ ÙˆØ§Ù„Ø£Ø³Ù‡Ù… -->
    <div class="flex items-center justify-center gap-4">

      <!-- Ø§Ù„Ø³Ø§Ø¨Ù‚ + Ø³Ù‡Ù… -->
      <button id="back" class="flex items-center gap-2 px-6 py-3 bg-gray-700 text-white rounded-lg hover:bg-gray-800">
        <span>â¬…</span>
        <span>Ø§Ù„Ø³Ø§Ø¨Ù‚</span>
      </button>

      <!-- ØªÙƒØ±Ø§Ø± + Ø´ÙƒÙ„ (ÙŠØ­Ø¯Ø« Ø§Ù„Ø±Ù‚Ù… Ù†ÙØ³Ù‡ ÙÙ‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª) -->
      <button id="repeatBtn" class="flex items-center gap-2 px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700">
        <span>ðŸ”„</span>
        <span>ØªÙƒØ±Ø§Ø±</span>
      </button>

      <!-- Ø§Ù„ØªØ§Ù„ÙŠ + Ø³Ù‡Ù… -->
      <button id="adv" class="flex items-center gap-2 px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">
        <span>Ø§Ù„ØªØ§Ù„ÙŠ</span>
        <span>âž¡</span>
      </button>

    </div>

    <!-- ØªØ¹ÙŠÙŠÙ† Ø±Ù‚Ù… Ù…Ø¹ÙŠÙ† -->
    <div class="flex gap-2">
      <input id="setInp" type="number" min="0" placeholder="Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯" class="flex-1 p-3 border rounded-lg text-center">
      <button id="setBtn" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">ØªØ¹ÙŠÙŠÙ†</button>
    </div>

    <button id="reset" class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§Ø¨ÙˆØ±</button>

    <p id="statusMsg" class="text-sm text-gray-600 text-center"></p>
  </div>

  <script type="module">
    import { db, ref, get, update, onValue, push } from "./js/firebase-config.js";
    import { announce, buildSpeedControl } from "./js/tts.js";

    /* ---------- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙØ­Ø© ---------- */
    const clinicSelect = document.getElementById('clinicSelect');
    const passwordInp  = document.getElementById('passwordInp');
    const loginBtn     = document.getElementById('loginBtn');
    const errorMsg     = document.getElementById('errorMsg');
    const controlPanel = document.getElementById('controlPanel');

    let currentClinic = null; // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„

    /* ---------- Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª + Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ---------- */
    onValue(ref(db, 'clinics'), snap => {
      clinicSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯Ø© --</option>';
      snap.forEach(ch => {
        const {name} = ch.val();
        clinicSelect.insertAdjacentHTML('beforeend', `<option value="${ch.key}">${name}</option>`);
      });
    });

    /* ---------- Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹ÙŠØ§Ø¯Ø©: Ø£Ø¸Ù‡Ø± Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---------- */
    clinicSelect.addEventListener('change', () => {
      passwordInp.classList.remove('hidden');
      loginBtn.classList.remove('hidden');
      errorMsg.classList.add('hidden');
    });

    /* ---------- Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---------- */
    loginBtn.addEventListener('click', async () => {
      const clinicId = clinicSelect.value;
      const pass     = passwordInp.value.trim();
      if (!clinicId || !pass) { errorMsg.textContent = 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'; errorMsg.classList.remove('hidden'); return; }

      const clinicSnap = await get(ref(db, `clinics/${clinicId}`));
      if (!clinicSnap.exists()) { errorMsg.textContent = 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'; errorMsg.classList.remove('hidden'); return; }

      const clinic = clinicSnap.val();
      if (clinic.password !== pass) { errorMsg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'; errorMsg.classList.remove('hidden'); return; }

      // Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­: Ø£Ø®ÙÙ‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ£Ø¸Ù‡Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…
      currentClinic = { id: clinicId, ...clinic };
      document.querySelector('.max-w-2xl.mx-auto.bg-white.p-6.rounded-2xl.shadow-xl.mb-6').classList.add('hidden');
      controlPanel.classList.remove('hidden');
      buildSpeedControl();
      listenToClinic(); // Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù‚Ù„ currentNumber ÙÙ‚Ø·
    });

    /* ---------- Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù‚Ù„ currentNumber ÙÙ‚Ø· (Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©) ---------- */
    function listenToClinic() {
      onValue(ref(db, `clinics/${currentClinic.id}/currentNumber`), snap => {
        const num = snap.val() ?? 0;
        document.getElementById('clinicNumber').textContent = num;
      });
    }

    /* ---------- ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ­ÙƒÙ… + Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØ³Ø§Ø±Ø¹ (Debounce) ---------- */
    const api = {
      advanceNumber: async () => {
        const nn = (currentClinic.currentNumber || 0) + 1;
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        currentClinic.currentNumber = nn;
        announce(currentClinic.name, currentClinic.currentNumber);
      },
      goBackNumber: async () => {
        const nn = Math.max(0, (currentClinic.currentNumber || 0) - 1);
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        currentClinic.currentNumber = nn;
        announce(currentClinic.name, currentClinic.currentNumber);
      },
      setNumber: async (v) => {
        const n = parseInt(v, 10);
        if (!isNaN(n) && n >= 0) {
            await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: n });
            currentClinic.currentNumber = n;
            announce(currentClinic.name, currentClinic.currentNumber);
        }
      },
      resetNumber: async () => {
        // 1- Ù†Ø¹ÙŠØ¯ Ø§Ù„Ø±Ù‚Ù… Ø¥Ù„Ù‰ ØµÙØ±
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: 0 });
        currentClinic.currentNumber = 0;
        // 2- Ù†Ù†Ø·Ù‚ Ù…Ù„Ù reset.mp3 (Ø¨Ø¯ÙˆÙ† Ø¬Ù…Ù„Ø© Ø§Ù„Ø¹Ù…ÙŠÙ„)
const audio = new Audio('file:///storage/emulated/0/Audio/reset.mp3');
        audio.play().catch(() => {});
      }
    };

    /* ---------- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… + Ø²Ø± ØªÙƒØ±Ø§Ø± + Ø²Ø± ØªØ¹ÙŠÙŠÙ† + Ù†Ø·Ù‚ + Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† ---------- */
    const clientInp   = document.getElementById('clientInp');
    const sendBtn     = document.getElementById('sendBtn');
    const micBtn      = document.getElementById('micBtn');
    const statusMsg   = document.getElementById('statusMsg');
    const repeatBtn   = document.getElementById('repeatBtn');

    // Ø¯Ø§Ù„Ø© Debounce (Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØ³Ø§Ø±Ø¹)
    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    document.getElementById('adv').addEventListener('click', () => api.advanceNumber());
    document.getElementById('back').addEventListener('click', () => api.goBackNumber());
    document.getElementById('setBtn').addEventListener('click', () => api.setNumber(document.getElementById('setInp').value));
    document.getElementById('reset').addEventListener('click', () => api.resetNumber());

    // Ø²Ø± ØªÙƒØ±Ø§Ø± (Debounced Ù„Ù…Ù†Ø¹ Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…ØªØ³Ø§Ø±Ø¹) + ÙŠØ­Ø¯Ø« Ø§Ù„Ø±Ù‚Ù… Ù†ÙØ³Ù‡ ÙÙ‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª â†’ ÙŠØ­Ø¯Ø« ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶
    repeatBtn.addEventListener('click', debounce(async () => {
      // Ù†ÙƒØ±Ø± Ø§Ù„Ù†Ø·Ù‚ ÙˆÙ†Ø­Ø¯Ø« Ø§Ù„Ø±Ù‚Ù… Ù†ÙØ³Ù‡ ÙÙ‰ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (ÙŠÙØ­Ø¯Ø« ØµÙØ­Ø© Ø§Ù„Ø¹Ø±Ø¶)
      await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: currentClinic.currentNumber });
      announce(currentClinic.name, currentClinic.currentNumber);
    }, 600)); // 600 Ù…Ù„Ù„Ù‰ Ø«Ø§Ù†ÙŠØ© Ø¨ÙŠÙ† ÙƒÙ„ Ø¶ØºØ·Ø©

    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„
    sendBtn.addEventListener('click', () => {
      const name = clientInp.value.trim();
      if (!name) { statusMsg.textContent = 'Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ù…ÙŠÙ„ Ø£ÙˆÙ„Ø§Ù‹'; return; }
      set(ref(db, 'currentClient'), { name: name, clinic: currentClinic.name, timestamp: Date.now() });
      statusMsg.textContent = 'ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙˆØ¹Ø±Ø¶Ù‡ Ø¹Ù„Ù‰ Ø§Ù„Ø´Ø§Ø´Ø©';
      clientInp.value = '';
    });

    // ØªØ³Ø¬ÙŠÙ„ ØµÙˆØªÙŠ
    let mediaRecorder;
    let audioChunks = [];
    micBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) { statusMsg.textContent = 'Ø§Ù„Ù…ØªØµÙØ­ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ÙŠÙƒØ±ÙˆÙÙˆÙ†'; return; }
      statusMsg.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ³Ø¬ÙŠÙ„... Ø§Ø¶ØºØ· Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„Ø¥ÙŠÙ‚Ø§Ù';
      if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); return; }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(audioBlob);
        set(ref(db, 'currentClient'), { audioURL: url, clinic: currentClinic.name, timestamp: Date.now() });
        statusMsg.textContent = 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„Ù‡';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
    });

    /* ---------- Ù…Ø´ØºÙ„ Ù…ØªØ³Ù„Ø³Ù„ (ÙÙŠØ¯ÙŠÙˆ + ØµÙˆØ±) ---------- */
const mediaBase = 'file:///storage/emulated/0/Media/';
    const playlist = ['1.mp4', '2.jpg', '3.mp4', '4.png']; // Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§ØªÙƒ
    let current = 0;
    const player = document.getElementById('seqPlayer');
    const image  = document.getElementById('seqImage');

    function playNext() { current = (current + 1) % playlist.length; loadMedia(); }
    function loadMedia() {
      const src = mediaBase + playlist[current];
      const isVideo = /\.(mp4|webm|ogg)$/i.test(playlist[current]);
      if (isVideo) {
        image.classList.add('hidden'); player.classList.remove('hidden');
        player.src = src; player.play().catch(() => {});
      } else {
        player.classList.add('hidden'); image.classList.remove('hidden');
        image.src = src; setTimeout(playNext, 4000);
      }
    }
    player.addEventListener('ended', playNext); player.addEventListener('error', playNext);
    loadMedia();

    /* ---------- Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…ÙƒØ§Ù† + Ø§Ù„ØªØ§Ø±ÙŠØ® ÙˆØ§Ù„Ø³Ø§Ø¹Ø© Ø§Ù„Ø­ÙŠØ© ---------- */
    function updateDateTime() {
      const now = new Date();
      const dateStr = now.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
      const timeStr = now.toLocaleTimeString('ar-EG');
      if (!document.getElementById('dateTime')) {
        const div = document.createElement('div');
        div.id = 'dateTime';
        div.className = 'text-center text-sm text-[#004156] mb-4';
        document.body.insertBefore(div, document.body.firstChild);
      }
      document.getElementById('dateTime').textContent = `Ù…Ø±ÙƒØ² ØºØ±Ø¨ Ø§Ù„Ù…Ø·Ø§Ø± - ${dateStr} - ${timeStr}`;
    }
    updateDateTime();
    setInterval(updateDateTime, 1000);
  </script>
</body>
</html>


