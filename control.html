<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم - مركز غرب المطار</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=wap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #d0e6f2; }
    .card { background: #ffffff; border-radius: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,.08); }
    .highlight { background: #fef3c7 !important; animation: blink 0.6s ease-in-out 4; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;}}
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- اختيار العيادة + كلمة المرور -->
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4">
    <h2 class="text-xl font-bold text-[#004156]">اختر عيادتك</h2>
    <select id="clinicSelect" class="w-full p-3 border rounded-lg text-lg">
      <option value="" disabled selected>-- اختر عيادة --</option>
    </select>
    <input id="passwordInp" type="password" placeholder="كلمة مرور العيادة" class="w-full p-3 border rounded-lg text-lg hidden">
    <button id="loginBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 hidden">دخول</button>
    <p id="errorMsg" class="text-sm text-red-600 text-center hidden"></p>
  </div>

  <!-- أدوات التحكم (تظهر بعد الدخول) -->
  <div id="controlPanel" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <h2 id="clinicName" class="text-3xl font-bold text-center text-[#004156]"></h2>
    <p id="clinicNumber" class="text-7xl font-extrabold text-center text-[#2a3e48]"></p>

    <!-- زر التكرار + عدد المرات -->
    <div class="flex items-center gap-3">
      <label class="text-sm font-bold text-[#004156]">عدد مرات التكرار:</label>
      <input id="repeatCount" type="number" min="1" max="10" value="1" class="w-20 p-2 border rounded text-center">
      <button id="repeatBtn" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700">تكرار</button>
    </div>

    <div class="grid grid-cols-2 gap-4">
      <button id="adv" class="py-3 px-6 bg-blue-700 text-white rounded-lg hover:bg-blue-800">تقدم</button>
      <button id="back" class="py-3 px-6 bg-gray-700 text-white rounded-lg hover:bg-gray-800">رجوع</button>
    </div>

    <div class="flex gap-2">
      <input id="setInp" type="number" min="0" placeholder="رقم جديد" class="flex-1 p-3 border rounded-lg text-center">
      <button id="setBtn" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">تعيين</button>
    </div>

    <button id="reset" class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">إعادة تعيين الطابور</button>

    <p id="statusMsg" class="text-sm text-gray-600 text-center"></p>
  </div>

  <script type="module">
    import { db, ref, get, update, onValue } from "./js/firebase-config.js";
    import { announce, speak } from "./js/tts.js";

    /* ---------- متغيرات الصفحة ---------- */
    const clinicSelect = document.getElementById('clinicSelect');
    const passwordInp  = document.getElementById('passwordInp');
    const loginBtn     = document.getElementById('loginBtn');
    const errorMsg     = document.getElementById('errorMsg');
    const controlPanel = document.getElementById('controlPanel');
    const repeatCount  = document.getElementById('repeatCount');
    const repeatBtn    = document.getElementById('repeatBtn');

    let currentClinic = null; // بيانات العيادة بعد الدخول

    /* ---------- ملء قائمة العيادات + استماع التغييرات ---------- */
    onValue(ref(db, 'clinics'), snap => {
      clinicSelect.innerHTML = '<option value="" disabled selected>-- اختر عيادة --</option>';
      snap.forEach(ch => {
        const {name} = ch.val();
        clinicSelect.insertAdjacentHTML('beforeend', `<option value="${ch.key}">${name}</option>`);
      });
    });

    /* ---------- عند اختيار عيادة: أظهر حقل كلمة المرور ---------- */
    clinicSelect.addEventListener('change', () => {
      passwordInp.classList.remove('hidden');
      loginBtn.classList.remove('hidden');
      errorMsg.classList.add('hidden');
    });

    /* ---------- زر الدخول: التحقق من كلمة المرور ---------- */
    loginBtn.addEventListener('click', async () => {
      const clinicId = clinicSelect.value;
      const pass     = passwordInp.value.trim();
      if (!clinicId || !pass) { errorMsg.textContent = 'أكمل الحقول أولاً'; errorMsg.classList.remove('hidden'); return; }

      const clinicSnap = await get(ref(db, `clinics/${clinicId}`));
      if (!clinicSnap.exists()) { errorMsg.textContent = 'العيادة غير موجودة'; errorMsg.classList.remove('hidden'); return; }

      const clinic = clinicSnap.val();
      if (clinic.password !== pass) { errorMsg.textContent = 'كلمة المرور خاطئة'; errorMsg.classList.remove('hidden'); return; }

      // دخول ناجح: أخفى حقول الدخول وأظهر أدوات التحكم
      currentClinic = { id: clinicId, ...clinic };
      document.querySelector('.max-w-2xl.mx-auto.bg-white.p-6.rounded-2xl.shadow-xl.mb-6').classList.add('hidden');
      controlPanel.classList.remove('hidden');
      listenToClinic(); // استماع لحقل currentNumber فقط
    });

    /* ---------- استماع لحقل currentNumber فقط (للعيادة المختارة) ---------- */
    function listenToClinic() {
      document.getElementById('clinicName').textContent = currentClinic.name;
      onValue(ref(db, `clinics/${currentClinic.id}/currentNumber`), snap => {
        const num = snap.val() ?? 0;
        document.getElementById('clinicNumber').textContent = num;
      });
    }

    /* ---------- أزرار التحكم فى الرقم + زر التكرار + إدخال اسم العميل + تسجيل صوتي ---------- */
    const clientInp   = document.getElementById('clientName');
    const sendBtn     = document.getElementById('sendBtn');
    const micBtn      = document.getElementById('micBtn');
    const statusMsg   = document.getElementById('statusMsg');

    // زر التكرار
    repeatBtn.addEventListener('click', async () => {
      const count = parseInt(repeatCount.value, 10) || 1;
      for (let i = 0; i < count; i++) {
        await api.advanceNumber();
        await new Promise(r => setTimeout(r, 800)); // فاصل 0.8 ثانية بين كل تكرار
      }
    });

    // أزرار التحكم الأساسية
    document.getElementById('adv').addEventListener('click', async () => {
      await api.advanceNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });
    document.getElementById('back').addEventListener('click', async () => {
      await api.goBackNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });
    document.getElementById('setBtn').addEventListener('click', async () => {
      const v = document.getElementById('setInp').value;
      if (v !== '') { await api.setNumber(v); document.getElementById('setInp').value = ''; }
    });
    document.getElementById('reset').addEventListener('click', async () => {
      await api.resetNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });

    // إرسال اسم العميل
    sendBtn.addEventListener('click', () => {
      const name = clientInp.value.trim();
      if (!name) { statusMsg.textContent = 'أدخل اسم العميل أولاً'; return; }
      set(ref(db, 'currentClient'), { name: name, clinic: currentClinic.name, timestamp: Date.now() });
      statusMsg.textContent = 'تم الإرسال وعرضه على الشاشة';
      clientInp.value = '';
    });

    // تسجيل صوتي
    let mediaRecorder;
    let audioChunks = [];
    micBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) { statusMsg.textContent = 'المتصفح لا يدعم الميكروفون'; return; }
      statusMsg.textContent = 'جاري التسجيل... اضغط مرة أخرى للإيقاف';
      if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); return; }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(audioBlob);
        set(ref(db, 'currentClient'), { audioURL: url, clinic: currentClinic.name, timestamp: Date.now() });
        statusMsg.textContent = 'تم التسجيل وإرساله';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
    });

    /* ---------- عنصر تحكم السرعة ---------- */
    buildSpeedControl();
  </script>
</body>
</html>
