<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Tajawal', sans-serif; background: #d0e6f2; }
    .clinicCard { background: #ffffff; border-radius: 1rem; box-shadow: 0 8px 20px rgba(0,0,0,.08); transition: background 0.4s; }
    .highlight { background: #fef3c7 !important; animation: blink 0.6s ease-in-out 4; }
    @keyframes blink { 0%,100%{opacity:1;} 50%{opacity:0.4;}}
    /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ù‡Ù… + Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚ */
    .arrowBtn  { background: #0288d1; color: white; border-radius: 50%; width: 4rem; height: 4rem; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; transition: background 0.3s; }
    .arrowBtn:hover { background: #0269a4; }
    .repeatBtn { background: #0288d1; color: white; border-radius: 50%; width: 3rem; height: 3rem; display: flex; align-items: center; justify-content: center; font-size: 1.4rem; transition: background 0.3s; }
    .repeatBtn:hover { background: #0269a4; }
  </style>
</head>
<body class="min-h-screen p-6">

  <!-- Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© + ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4">
    <h2 class="text-xl font-bold text-[#004156]">Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯ØªÙƒ</h2>
    <select id="clinicSelect" class="w-full p-3 border rounded-lg text-lg">
      <option value="" disabled selected>-- Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯Ø© --</option>
    </select>
    <input id="passwordInp" type="password" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ø¹ÙŠØ§Ø¯Ø©" class="w-full p-3 border rounded-lg text-lg hidden">
    <button id="loginBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 hidden">Ø¯Ø®ÙˆÙ„</button>
    <p id="errorMsg" class="text-sm text-red-600 text-center hidden"></p>
  </div>

  <!-- Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ… (ØªØ¸Ù‡Ø± Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„) -->
  <div id="controlPanel" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <h2 id="clinicName" class="text-3xl font-bold text-center text-[#004156]"></h2>
    <p id="clinicNumber" class="text-7xl font-extrabold text-center text-[#2a3e48]"></p>

    <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… (Ø£Ø³Ù‡Ù… + Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚) -->
    <div class="flex items-center justify-center gap-4">
      <!-- Ø³Ù‡Ù… Ø±Ø¬ÙˆØ¹ -->
      <button id="back" class="arrowBtn" title="Ø±Ø¬ÙˆØ¹">â†</button>

      <!-- Ø²Ø± Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚ -->
      <button id="repeat" class="repeatBtn" title="Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚">ğŸ”Š</button>

      <!-- Ø³Ù‡Ù… ØªÙ‚Ø¯Ù… -->
      <button id="adv" class="arrowBtn" title="ØªÙ‚Ø¯Ù…">â†’</button>
    </div>

    <div class="flex gap-2">
      <input id="setInp" type="number" min="0" placeholder="Ø±Ù‚Ù… Ø¬Ø¯ÙŠØ¯" class="flex-1 p-3 border rounded-lg text-center">
      <button id="setBtn" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">ØªØ¹ÙŠÙŠÙ†</button>
    </div>

    <button id="reset" class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ø·Ø§Ø¨ÙˆØ±</button>

    <p id="statusMsg" class="text-sm text-gray-600 text-center"></p>
  </div>

  <script type="module">
    import { db, ref, get, update, onValue } from "./js/firebase-config.js";
    import { announce, buildSpeedControl } from "./js/tts.js";

    /* ---------- Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØµÙØ­Ø© ---------- */
    const clinicSelect = document.getElementById('clinicSelect');
    const passwordInp  = document.getElementById('passwordInp');
    const loginBtn     = document.getElementById('loginBtn');
    const errorMsg     = document.getElementById('errorMsg');
    const controlPanel = document.getElementById('controlPanel');

    let currentClinic = null; // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø¯Ø®ÙˆÙ„

    /* ---------- Ù…Ù„Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¹ÙŠØ§Ø¯Ø§Øª + Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª ---------- */
    onValue(ref(db, 'clinics'), snap => {
      clinicSelect.innerHTML = '<option value="" disabled selected>-- Ø§Ø®ØªØ± Ø¹ÙŠØ§Ø¯Ø© --</option>';
      snap.forEach(ch => {
        const {name} = ch.val();
        clinicSelect.insertAdjacentHTML('beforeend', `<option value="${ch.key}">${name}</option>`);
      });
    });

    /* ---------- Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¹ÙŠØ§Ø¯Ø©: Ø£Ø¸Ù‡Ø± Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---------- */
    clinicSelect.addEventListener('change', () => {
      passwordInp.classList.remove('hidden');
      loginBtn.classList.remove('hidden');
      errorMsg.classList.add('hidden');
    });

    /* ---------- Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ---------- */
    loginBtn.addEventListener('click', async () => {
      const clinicId = clinicSelect.value;
      const pass     = passwordInp.value.trim();
      if (!clinicId || !pass) { errorMsg.textContent = 'Ø£ÙƒÙ…Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹'; errorMsg.classList.remove('hidden'); return; }

      const clinicSnap = await get(ref(db, `clinics/${clinicId}`));
      if (!clinicSnap.exists()) { errorMsg.textContent = 'Ø§Ù„Ø¹ÙŠØ§Ø¯Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©'; errorMsg.classList.remove('hidden'); return; }

      const clinic = clinicSnap.val();
      if (clinic.password !== pass) { errorMsg.textContent = 'ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø®Ø§Ø·Ø¦Ø©'; errorMsg.classList.remove('hidden'); return; }

      // Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­: Ø£Ø®ÙÙ‰ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ£Ø¸Ù‡Ø± Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØ­ÙƒÙ…
      currentClinic = { id: clinicId, ...clinic };
      document.querySelector('.max-w-2xl.mx-auto.bg-white.p-6.rounded-2xl.shadow-xl.mb-6').classList.add('hidden');
      controlPanel.classList.remove('hidden');
      buildSpeedControl();
      listenToClinic();
    });

    /* ---------- Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø­Ù‚Ù„ currentNumber ÙÙ‚Ø· (Ù„Ù„Ø¹ÙŠØ§Ø¯Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©) ---------- */
    function listenToClinic() {
      onValue(ref(db, `clinics/${currentClinic.id}/currentNumber`), snap => {
        const num = snap.val() ?? 0;
        document.getElementById('clinicNumber').textContent = num;
      });
    }

    /* ---------- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… ÙÙ‰ Ø§Ù„Ø±Ù‚Ù… + Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚ ---------- */
    const api = {
      advanceNumber: async () => {
        const nn = (currentClinic.currentNumber || 0) + 1;
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        currentClinic.currentNumber = nn;
      },
      goBackNumber: async () => {
        const nn = Math.max(0, (currentClinic.currentNumber || 0) - 1);
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        currentClinic.currentNumber = nn;
      },
      setNumber: async (v) => {
        const n = parseInt(v, 10);
        if (!isNaN(n) && n >= 0) {
          await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: n });
          currentClinic.currentNumber = n;
        }
      },
      resetNumber: async () => {
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: 0 });
        currentClinic.currentNumber = 0;
      }
    };

    /* ---------- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… + Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ù†Ø·Ù‚ ---------- */
    document.getElementById('adv').addEventListener('click', async () => {
      await api.advanceNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });

    document.getElementById('back').addEventListener('click', async () => {
      await api.goBackNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });

    document.getElementById('repeat').addEventListener('click', () => {
      // Ø¥Ø¹Ø§Ø¯Ø© Ù†Ø·Ù‚ Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙ‚Ø· (Ø¨Ø¯ÙˆÙ† Ø§Ù„Ø¬Ù…Ù„Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©)
      speak(currentClinic.currentNumber.toString());
    });

    document.getElementById('setBtn').addEventListener('click', async () => {
      const v = document.getElementById('setInp').value;
      if (v !== '') { await api.setNumber(v); document.getElementById('setInp').value = ''; }
    });

    document.getElementById('reset').addEventListener('click', async () => {
      await api.resetNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });

    /* ---------- Ù…Ø´ØºÙ„ Ù…ØªØ³Ù„Ø³Ù„ (ÙÙŠØ¯ÙŠÙˆ + ØµÙˆØ±) Ù…Ù† Ù…Ø¬Ù„Ø¯ media/ Ø¹Ù„Ù‰ GitHub ---------- */
    const mediaBase = 'https://raw.githubusercontent.com/ledooooo/queue/main/media/'; // ØºÙŠÙ‘Ø±Ù‡Ø§ Ù„Ø±Ø§Ø¨Ø·Ùƒ
    // Ø£Ùˆ Ù„Ùˆ Ø¹Ù„Ù‰ Ù†ÙØ³ Ø§Ù„Ø³ÙŠØ±ÙØ±: const mediaBase = './media/';

    const playlist = [
      '1.mp4', '2.jpg', '3.mp4', '4.png' // Ø§ÙƒØªØ¨ Ø£Ø³Ù…Ø§Ø¡ Ù…Ù„ÙØ§ØªÙƒ Ø¨Ø§Ù„ØªØ±ØªÙŠØ¨ Ù‡Ù†Ø§
    ];

    let current = 0;
    const player = document.getElementById('seqPlayer');
    const image  = document.getElementById('seqImage');

    function playNext() {
      current = (current + 1) % playlist.length;
      loadMedia();
    }

    function loadMedia() {
      const src = mediaBase + playlist[current];
      const isVideo = /\.(mp4|webm|ogg)$/i.test(playlist[current]);

      if (isVideo) {
        image.classList.add('hidden');
        player.classList.remove('hidden');
        player.src = src;
        player.play().catch(() => {});
      } else {
        player.classList.add('hidden');
        image.classList.remove('hidden');
        image.src = src;
        setTimeout(playNext, 4000);
      }
    }

    player.addEventListener('ended', playNext);
    player.addEventListener('error', playNext);
    loadMedia();
  </script>
</body>
</html>
