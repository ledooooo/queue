<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>لوحة التحكم</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
  <style>body{font-family:'Tajawal',sans-serif;background:#d0e6f2}</style>
</head>
<body class="min-h-screen p-6">

  <h1 class="text-3xl font-bold text-center text-[#004156] mb-6">لوحة التحكم</h1>

  <!-- اختيار العيادة + كلمة المرور -->
  <div class="max-w-2xl mx-auto bg-white p-6 rounded-2xl shadow-xl mb-6 space-y-4">
    <h2 class="text-xl font-bold text-[#004156]">اختر عيادتك</h2>

    <!-- قائمة العيادات -->
    <select id="clinicSelect" class="w-full p-3 border rounded-lg text-lg">
      <option value="" disabled selected>-- اختر عيادة --</option>
    </select>

    <!-- كلمة المرور (تظهر بعد اختيار العيادة) -->
    <input id="passwordInp" type="password" placeholder="كلمة مرور العيادة" class="w-full p-3 border rounded-lg text-lg hidden">

    <!-- زر الدخول -->
    <button id="loginBtn" class="w-full py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800 hidden">دخول</button>

    <!-- رسالة خطأ -->
    <p id="errorMsg" class="text-sm text-red-600 text-center hidden"></p>
  </div>

  <!-- أدوات التحكم (تظهر بعد الدخول) -->
  <div id="controlPanel" class="max-w-2xl mx-auto bg-white p-8 rounded-2xl shadow-xl space-y-6 hidden">

    <h2 id="clinicName" class="text-3xl font-bold text-center text-[#004156]"></h2>
    <p id="clinicNumber" class="text-7xl font-extrabold text-center text-[#2a3e48]"></p>

    <div class="grid grid-cols-2 gap-4">
      <button id="adv" class="py-3 px-6 bg-blue-700 text-white rounded-lg hover:bg-blue-800">تقدم</button>
      <button id="back" class="py-3 px-6 bg-gray-700 text-white rounded-lg hover:bg-gray-800">رجوع</button>
    </div>

    <div class="flex gap-2">
      <input id="setInp" type="number" min="0" placeholder="رقم جديد" class="flex-1 p-3 border rounded-lg text-center">
      <button id="setBtn" class="px-6 py-3 bg-blue-700 text-white rounded-lg hover:bg-blue-800">تعيين</button>
    </div>

    <button id="reset" class="w-full py-3 bg-red-600 text-white rounded-lg hover:bg-red-700">إعادة تعيين الطابور</button>

    <p id="statusMsg" class="text-sm text-gray-600 text-center"></p>
  </div>

  <!-- عنصر تحكم السرعة -->
  <div id="controlSpeed" class="max-w-2xl mx-auto mt-6 hidden"></div>

  <script type="module">
    import { db, ref, get, update, onValue } from "./js/firebase-config.js";
    import { announce, buildSpeedControl } from "./js/tts.js";

    /* ---------- متغيرات الصفحة ---------- */
    const clinicSelect = document.getElementById('clinicSelect');
    const passwordInp  = document.getElementById('passwordInp');
    const loginBtn     = document.getElementById('loginBtn');
    const errorMsg     = document.getElementById('errorMsg');
    const controlPanel = document.getElementById('controlPanel');

    let currentClinic = null; // بيانات العيادة بعد الدخول

    /* ---------- ملء قائمة العيادات + استماع التغييرات ---------- */
    onValue(ref(db, 'clinics'), snap => {
      clinicSelect.innerHTML = '<option value="" disabled selected>-- اختر عيادة --</option>';
      snap.forEach(ch => {
        const {name} = ch.val();
        clinicSelect.insertAdjacentHTML('beforeend', `<option value="${ch.key}">${name}</option>`);
      });
    });

    /* ---------- عند اختيار عيادة: أظهر حقل كلمة المرور ---------- */
    clinicSelect.addEventListener('change', () => {
      passwordInp.classList.remove('hidden');
      loginBtn.classList.remove('hidden');
      errorMsg.classList.add('hidden');
    });

    /* ---------- زر الدخول: التحقق من كلمة المرور ---------- */
    loginBtn.addEventListener('click', async () => {
      const clinicId = clinicSelect.value;
      const pass     = passwordInp.value.trim();
      if (!clinicId || !pass) { errorMsg.textContent = 'أكمل الحقول أولاً'; errorMsg.classList.remove('hidden'); return; }

      const clinicSnap = await get(ref(db, `clinics/${clinicId}`));
      if (!clinicSnap.exists()) { errorMsg.textContent = 'العيادة غير موجودة'; errorMsg.classList.remove('hidden'); return; }

      const clinic = clinicSnap.val();
      if (clinic.password !== pass) { errorMsg.textContent = 'كلمة المرور خاطئة'; errorMsg.classList.remove('hidden'); return; }

      // دخول ناجح: أخفى حقول الدخول وأظهر أدوات التحكم
      currentClinic = { id: clinicId, ...clinic };
      document.querySelector('.max-w-2xl.mx-auto.bg-white.p-6.rounded-2xl.shadow-xl.mb-6').classList.add('hidden');
      controlPanel.classList.remove('hidden');
      buildSpeedControl();
      listenToClinic(); // استماع لحقل currentNumber فقط
    });

    /* ---------- استماع لحقل currentNumber فقط (للعيادة المختارة) ---------- */
    function listenToClinic() {
      onValue(ref(db, `clinics/${currentClinic.id}/currentNumber`), snap => {
        const num = snap.val() ?? 0;
        document.getElementById('clinicNumber').textContent = num;
      });
    }

    /* ---------- أزرار التحكم فى الرقم ---------- */
    const api = {
      advanceNumber: async () => {
        const nn = (currentClinic.currentNumber || 0) + 1;
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        currentClinic.currentNumber = nn;
      },
      goBackNumber: async () => {
        const nn = Math.max(0, (currentClinic.currentNumber || 0) - 1);
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: nn });
        currentClinic.currentNumber = nn;
      },
      setNumber: async (v) => {
        const n = parseInt(v, 10);
        if (!isNaN(n) && n >= 0) {
          await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: n });
          currentClinic.currentNumber = n;
        }
      },
      resetNumber: async () => {
        await update(ref(db, `clinics/${currentClinic.id}`), { currentNumber: 0 });
        currentClinic.currentNumber = 0;
      }
    };

    /* ---------- أزرار التحكم + إدخال اسم العميل + تسجيل صوتي ---------- */
    const clientInp   = document.getElementById('clientName');
    const sendBtn     = document.getElementById('sendBtn');
    const micBtn      = document.getElementById('micBtn');
    const statusMsg   = document.getElementById('statusMsg');

    // أزرار التحكم
    document.getElementById('adv').addEventListener('click', async () => {
      await api.advanceNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });
    document.getElementById('back').addEventListener('click', async () => {
      await api.goBackNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });
    document.getElementById('setBtn').addEventListener('click', async () => {
      const v = document.getElementById('setInp').value;
      if (v !== '') { await api.setNumber(v); document.getElementById('setInp').value = ''; }
    });
    document.getElementById('reset').addEventListener('click', async () => {
      await api.resetNumber();
      announce(currentClinic.name, currentClinic.currentNumber);
    });

    // إرسال اسم العميل
    sendBtn.addEventListener('click', () => {
      const name = clientInp.value.trim();
      if (!name) { statusMsg.textContent = 'أدخل اسم العميل أولاً'; return; }
      set(ref(db, 'currentClient'), { name: name, clinic: currentClinic.name, timestamp: Date.now() });
      statusMsg.textContent = 'تم الإرسال وعرضه على الشاشة';
      clientInp.value = '';
    });

    // تسجيل صوتي
    let mediaRecorder;
    let audioChunks = [];
    micBtn.addEventListener('click', async () => {
      if (!navigator.mediaDevices) { statusMsg.textContent = 'المتصفح لا يدعم الميكروفون'; return; }
      statusMsg.textContent = 'جاري التسجيل... اضغط مرة أخرى للإيقاف';
      if (mediaRecorder && mediaRecorder.state === 'recording') { mediaRecorder.stop(); return; }
      const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      mediaRecorder = new MediaRecorder(stream);
      audioChunks = [];
      mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
      mediaRecorder.onstop = () => {
        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
        const url = URL.createObjectURL(audioBlob);
        set(ref(db, 'currentClient'), { audioURL: url, clinic: currentClinic.name, timestamp: Date.now() });
        statusMsg.textContent = 'تم التسجيل وإرساله';
        stream.getTracks().forEach(t => t.stop());
      };
      mediaRecorder.start();
    });

    /* ---------- عنصر تحكم السرعة ---------- */
    buildSpeedControl();
  </script>
</body>
</html>
